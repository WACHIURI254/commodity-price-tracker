<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kenya Commodity Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .cheapest { background-color: #d4edda; } /* Highlight cheapest */
  </style>
</head>
<body>

<h1>Kenya Commodity Price Tracker</h1>

<input type="text" id="searchBox" placeholder="Search commodity..." oninput="filterTable()">

<table id="priceTable">
  <thead>
    <tr>
      <th>Commodity</th>
      <th>Unit</th>
      <th>Store</th>
      <th>Price (KES)</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Price Trends</h2>
<select id="trendPeriod" onchange="updateChart()">
  <option value="daily">Daily</option>
  <option value="weekly">Weekly</option>
  <option value="monthly">Monthly</option>
</select>
<canvas id="priceChart" width="800" height="400"></canvas>

<script>
let pricesData = [];
let chart;

async function loadPrices() {
  try {
    const response = await fetch('prices.json');
    pricesData = await response.json();
    displayTable();
    createChart();
  } catch (err) {
    console.error('Error loading prices.json:', err);
  }
}

function displayTable() {
  const tbody = document.querySelector('#priceTable tbody');
  tbody.innerHTML = '';

  // Group by commodity for cheapest highlighting
  const grouped = {};
  pricesData.forEach(item => {
    if (!grouped[item.name]) grouped[item.name] = [];
    grouped[item.name].push(item);
  });

  for (const commodity in grouped) {
    const items = grouped[commodity];
    let minPrice = Math.min(...items.map(i => parseFloat(i.price) || Infinity));

    items.forEach(i => {
      const tr = document.createElement('tr');
      if (parseFloat(i.price) === minPrice) tr.classList.add('cheapest');

      tr.innerHTML = `
        <td>${i.name}</td>
        <td>${i.unit || 'N/A'}</td>
        <td>${i.store || 'Unknown'}</td>
        <td>${i.price || 'N/A'}</td>
        <td>${formatDate(i.timestamp)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

function formatDate(ts) {
  const d = new Date(ts);
  return isNaN(d.getTime()) ? 'Unknown' : d.toLocaleString();
}

function filterTable() {
  const query = document.getElementById('searchBox').value.toLowerCase();
  const rows = document.querySelectorAll('#priceTable tbody tr');
  rows.forEach(row => {
    row.style.display = row.cells[0].textContent.toLowerCase().includes(query) ? '' : 'none';
  });
}

function createChart() {
  const ctx = document.getElementById('priceChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [], // timestamps
      datasets: [] // dynamic per commodity
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' }, title: { display: true, text: 'Price Trends' } }
    }
  });
  updateChart();
}

function updateChart() {
  const period = document.getElementById('trendPeriod').value;
  const now = new Date();
  let cutoff;

  if (period === 'daily') cutoff = new Date(now.getTime() - 24*60*60*1000);
  else if (period === 'weekly') cutoff = new Date(now.getTime() - 7*24*60*60*1000);
  else cutoff = new Date(now.getTime() - 30*24*60*60*1000);

  // Build datasets
  const commodities = [...new Set(pricesData.map(p => p.name))];
  chart.data.labels = [];
  chart.data.datasets = commodities.map(name => {
    const itemData = pricesData
      .filter(p => p.name === name && new Date(p.timestamp) >= cutoff)
      .sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));

    return {
      label: name,
      data: itemData.map(p => ({ x: new Date(p.timestamp), y: parseFloat(p.price) || null })),
      borderColor: getRandomColor(),
      fill: false,
      tension: 0.2
    };
  });

  // Collect unique timestamps for x-axis
  const allTimestamps = new Set();
  chart.data.datasets.forEach(ds => ds.data.forEach(p=>allTimestamps.add(p.x)));
  chart.data.labels = Array.from(allTimestamps).sort((a,b)=>a-b).map(d=>new Date(d).toLocaleDateString());

  chart.update();
}

function getRandomColor() {
  const r = Math.floor(Math.random()*200);
  const g = Math.floor(Math.random()*200);
  const b = Math.floor(Math.random()*200);
  return `rgb(${r},${g},${b})`;
}

// Optional browser notification for cheapest item
function notifyCheapest() {
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") Notification.requestPermission();

  const cheapestItems = [];
  const grouped = {};
  pricesData.forEach(item => {
    if (!grouped[item.name]) grouped[item.name]=[];
    grouped[item.name].push(item);
  });

  for (const c in grouped) {
    const items = grouped[c];
    const minPrice = Math.min(...items.map(i=>parseFloat(i.price)||Infinity));
    const cheapest = items.find(i=>parseFloat(i.price)===minPrice);
    if (cheapest) cheapestItems.push(`${cheapest.name} @ ${cheapest.price} KES (${cheapest.store})`);
  }

  if (Notification.permission === "granted") {
    cheapestItems.forEach(text => new Notification("Cheapest Item", { body: text }));
  }
}

loadPrices();
</script>
</body>
</html>
