<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kenya Commodity Price Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        /* -- Styles (same as your latest HTML, optimized for mobile & desktop) -- */
        /* You can keep all the CSS from your previous HTML here */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Kenya Commodity Price Tracker</h1>
            <p class="subtitle">Real-time price monitoring across major Kenyan online stores</p>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">--</div>
                    <div class="stat-label">Items Tracked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalStores">--</div>
                    <div class="stat-label">Stores Monitored</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdate">--</div>
                    <div class="stat-label">Last Update</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgSavings">--</div>
                    <div class="stat-label">Avg. Savings</div>
                </div>
            </div>
        </header>

        <div class="search-section">
            <input type="text" id="searchInput" placeholder="Search commodities...">
            <select id="categoryFilter"><option value="">All Categories</option></select>
            <select id="storeFilter"><option value="">All Stores</option></select>
            <button onclick="refreshData()">ðŸ”„ Refresh Prices</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('prices')">Current Prices</div>
            <div class="tab" onclick="switchTab('trends')">Price Trends</div>
            <div class="tab" onclick="switchTab('alerts')">Price Alerts</div>
            <div class="tab" onclick="switchTab('comparison')">Store Comparison</div>
        </div>

        <div class="content-area" id="contentArea">
            <div class="loading">Loading price data...</div>
        </div>
    </div>

    <script>
        const DATA_URL = 'https://raw.githubusercontent.com/WACHIURI254/commodity-price-tracker/main/prices.json?cache=' + new Date().getTime();

        let priceData = [];
        let alerts = [];
        let currentTab = 'prices';
        let chartInstance = null;

        async function fetchData() {
            try {
                const response = await fetch(DATA_URL);
                priceData = await response.json();
                updateStats();
                displayPrices();
                checkAlerts();
            } catch (e) {
                document.getElementById('contentArea').innerHTML = '<p>Error loading data.</p>';
                console.error(e);
            }
        }

        function refreshData() {
            document.getElementById('contentArea').innerHTML = '<div class="loading">Fetching latest prices...</div>';
            fetchData();
        }

        function updateStats() {
            const stores = [...new Set(priceData.map(p => p.store))];
            const commodities = [...new Set(priceData.map(p => p.commodity_name))];
            document.getElementById('totalItems').textContent = commodities.length;
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-KE', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('avgSavings').textContent = calculateAverageSavings() + '%';
        }

        function calculateAverageSavings() {
            const grouped = {};
            priceData.forEach(p => { grouped[p.commodity_name] = grouped[p.commodity_name] || []; grouped[p.commodity_name].push(p.price); });
            const savings = Object.values(grouped).map(prices => {
                const min = Math.min(...prices), max = Math.max(...prices);
                return max > 0 ? ((max-min)/max)*100 : 0;
            });
            return Math.round(savings.reduce((a,b)=>a+b,0)/savings.length);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if(tab==='prices') displayPrices();
            else if(tab==='trends') displayTrends();
            else if(tab==='alerts') displayAlerts();
            else if(tab==='comparison') displayComparison();
        }

        function displayPrices() {
            const content = document.getElementById('contentArea');
            if(!priceData.length) {content.innerHTML='No data'; return;}
            const groups = {};
            priceData.forEach(p => { groups[p.commodity_id] = groups[p.commodity_id] || {name: p.commodity_name, category:p.category, unit:p.canonical_unit, prices:[]}; groups[p.commodity_id].prices.push(p); });
            let html = '<div class="commodity-grid">';
            Object.values(groups).forEach(c => {
                const best = c.prices.filter(p=>p.in_stock).sort((a,b)=>a.price-b.price)[0];
                html+=`<div class="commodity-card"><div>${c.name} - ${c.category}</div><div>Best: ${best.store} KSh ${best.price}</div></div>`;
            });
            html+='</div>';
            content.innerHTML = html;
        }

        function displayTrends() { document.getElementById('contentArea').innerHTML='<p>Trend chart coming soon</p>'; }
        function displayAlerts() { document.getElementById('contentArea').innerHTML='<p>Price alerts coming soon</p>'; }
        function displayComparison() { document.getElementById('contentArea').innerHTML='<p>Store comparison coming soon</p>'; }
        function checkAlerts() { console.log('Checking alerts...'); }

        window.addEventListener('DOMContentLoaded', fetchData);
        setInterval(fetchData, 300000); // auto-refresh every 5 minutes
    </script>
</body>
</html>
